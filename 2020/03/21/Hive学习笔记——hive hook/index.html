<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hive学习笔记——hive hook | tonglin0325的个人主页</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Hive hook是hive的钩子函数，可以嵌入HQL执行的过程中运行，比如下面的这几种情况   参考 1https:&#x2F;&#x2F;www.slideshare.net&#x2F;julingks&#x2F;apache-hive-hooksminwookim130813  有了Hook，可以实现例如非法SQL拦截，SQL收集和审计等功能，业界的案例可以参考Airbnb的reair 1h">
<meta property="og:type" content="article">
<meta property="og:title" content="Hive学习笔记——hive hook">
<meta property="og:url" content="http://tonglin0325.github.io/2020/03/21/Hive%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94hive%20hook/index.html">
<meta property="og:site_name" content="tonglin0325的个人主页">
<meta property="og:description" content="Hive hook是hive的钩子函数，可以嵌入HQL执行的过程中运行，比如下面的这几种情况   参考 1https:&#x2F;&#x2F;www.slideshare.net&#x2F;julingks&#x2F;apache-hive-hooksminwookim130813  有了Hook，可以实现例如非法SQL拦截，SQL收集和审计等功能，业界的案例可以参考Airbnb的reair 1h">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://tonglin0325.github.io/images/517519-20200321193657092-1621988024.png">
<meta property="og:image" content="http://tonglin0325.github.io/images/517519-20200328153748662-155259969.png">
<meta property="og:image" content="http://tonglin0325.github.io/images/517519-20200331103303038-1025368439.png">
<meta property="og:image" content="http://tonglin0325.github.io/images/517519-20200331103513186-1595124067.png">
<meta property="og:image" content="http://tonglin0325.github.io/images/517519-20200321223815028-474591254.png">
<meta property="og:image" content="http://tonglin0325.github.io/images/517519-20200321223726000-124218584.png">
<meta property="og:image" content="http://tonglin0325.github.io/images/517519-20200321223922239-224576797.png">
<meta property="og:image" content="http://tonglin0325.github.io/images/517519-20200321224111206-227149050.png">
<meta property="article:published_time" content="2020-03-20T16:00:00.000Z">
<meta property="article:modified_time" content="2021-04-24T12:48:29.044Z">
<meta property="article:author" content="tonglin0325">
<meta property="article:tag" content="Hive">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://tonglin0325.github.io/images/517519-20200321193657092-1621988024.png">
  
    <link rel="alternate" href="/atom.xml" title="tonglin0325的个人主页" type="application/atom+xml">
  
  
    <link rel="icon" href="https://tonglin0325.github.io/images/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  
<link rel="stylesheet" href="/css/styles.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-166238833-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class=""
                 href="/index.html">主页</a></li>
        
          <li><a class=""
                 href="/archives/">所有文章</a></li>
        
          <li><a class=""
                 href="http://www.cnblogs.com/tonglin0325/">博客园</a></li>
        
          <li><a class=""
                 href="https://github.com/tonglin0325">Github</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
          <li><a href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a></li>
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">tonglin0325的个人主页</h1>
  
</div>

    <div class="row">
        <div class="col-sm-9 blog-main">
          <article id="post-Hive学习笔记——hive hook" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 class="article-title" itemprop="name">
      Hive学习笔记——hive hook
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2020/03/21/Hive%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94hive%20hook/" class="article-date"><time datetime="2020-03-20T16:00:00.000Z" itemprop="datePublished">2020-03-21</time></a>
</div>

    <div class="article-author">tonglin0325</div>
    

  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        
<div id="toc">
  
</div>

        <p>Hive hook是hive的钩子函数，可以嵌入HQL执行的过程中运行，比如下面的这几种情况</p>
<img src="/images/517519-20200321193657092-1621988024.png" alt width="400" height="309">

<p>参考</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.slideshare.net&#x2F;julingks&#x2F;apache-hive-hooksminwookim130813</span><br></pre></td></tr></table></figure>

<p>有了Hook，可以实现例如非法SQL拦截，SQL收集和审计等功能，业界的案例可以参考Airbnb的reair</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;airbnb&#x2F;reair</span><br></pre></td></tr></table></figure>

<p>该项目中就使用了Hive的hook函数实现了一个Audit Log Hook，将提交到hiveserver2上的query写入到MySQL当中收集起来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;airbnb&#x2F;reair&#x2F;blob&#x2F;master&#x2F;hive-hooks&#x2F;src&#x2F;main&#x2F;java&#x2F;com&#x2F;airbnb&#x2F;reair&#x2F;hive&#x2F;hooks&#x2F;CliAuditLogHook.java</span><br></pre></td></tr></table></figure>

<a id="more"></a>
<p>&nbsp;</p>
<p>这些hook函数的hive sql运行过程中的执行顺序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Driver.run()</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; HiveDriverRunHook.preDriverRun()(hive.exec.driver.run.hooks)</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; Driver.compile()</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; HiveSemanticAnalyzerHook.preAnalyze()(hive.semantic.analyzer.hook)</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; SemanticAnalyze(QueryBlock, LogicalPlan, PhyPlan, TaskTree)</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; HiveSemanticAnalyzerHook.postAnalyze()(hive.semantic.analyzer.hook)</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; QueryString redactor(hive.exec.query.redactor.hooks)</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; QueryPlan Generation</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; Authorization</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; Driver.execute()</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; ExecuteWithHookContext.run() || PreExecute.run() (hive.exec.pre.hooks)</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; TaskRunner</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; if failed, ExecuteWithHookContext.run()(hive.exec.failure.hooks)</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; ExecuteWithHookContext.run() || PostExecute.run() (hive.exec.post.hooks)</span><br><span class="line"></span><br><span class="line">&#x3D;&gt; HiveDriverRunHook.postDriverRun()(hive.exec.driver.run.hooks)</span><br></pre></td></tr></table></figure>

<p>参考</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;my.oschina.net&#x2F;kavn&#x2F;blog&#x2F;1514648</span><br></pre></td></tr></table></figure>

<p>&nbsp;</p>
<p><strong>1.ExecuteWithHookContext接口</strong></p>
<p>下面将实现ExecuteWithHookContext接口来实现一个钩子函数，其他的hook还有实现HiveSemanticAnalyzerHook接口，继承AbstractSemanticAnalyzerHook抽象类等</p>
<p>ExecuteWithHookContext可以实现3种类型的hook，分别是pre-execution,post-execution和execution-failure，这个在hive sql的执行过程中已经处于最后几个步骤了</p>
<img src="/images/517519-20200328153748662-155259969.png" alt width="650" height="122">

<p>&nbsp;</p>
<p>依赖</p>
<p>需要注意依赖的版本需要和集群保持一致，我的cdh集群的版本为cdh5.16.2</p>
<p>如果使用的是apache版本的1.1.0版本的hive-exec的话，代码的内容会和cloudera的1.1.0-cdh5.16.2的hive-exec会有些不同，比如</p>
<p>1.1.0-cdh5.16.2版本的TOK_QUERY=789</p>
<img src="/images/517519-20200331103303038-1025368439.png" alt width="600" height="205">

<p>但是1.1.0版本的TOK_QUERY=777</p>
<img src="/images/517519-20200331103513186-1595124067.png" alt width="600" height="330">

<p>&nbsp;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;POM&#x2F;4.0.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;interview-parent&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.interview&lt;&#x2F;groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;&#x2F;version&gt;</span><br><span class="line">    &lt;&#x2F;parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;&#x2F;modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;artifactId&gt;interview-bigdata&lt;&#x2F;artifactId&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- logback --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.slf4j&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;log4j-over-slf4j&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.7.25&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;!--hive--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.hive&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;hive-exec&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.0-cdh5.16.2&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.hive&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;hive-metastore&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.0-cdh5.16.2&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;!--hadoop--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.hadoop&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;hadoop-common&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.6.0-cdh5.16.2&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--&lt;build&gt;--&gt;</span><br><span class="line">        &lt;!--&lt;plugins&gt;--&gt;</span><br><span class="line">            &lt;!--&lt;plugin&gt;--&gt;</span><br><span class="line">                &lt;!--&lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;--&gt;</span><br><span class="line">                &lt;!--&lt;artifactId&gt;maven-shade-plugin&lt;&#x2F;artifactId&gt;--&gt;</span><br><span class="line">                &lt;!--&lt;executions&gt;--&gt;</span><br><span class="line">                    &lt;!--&lt;!&amp;ndash; Run shade goal on package phase &amp;ndash;&gt;--&gt;</span><br><span class="line">                    &lt;!--&lt;execution&gt;--&gt;</span><br><span class="line">                        &lt;!--&lt;phase&gt;package&lt;&#x2F;phase&gt;--&gt;</span><br><span class="line">                        &lt;!--&lt;goals&gt;--&gt;</span><br><span class="line">                            &lt;!--&lt;goal&gt;shade&lt;&#x2F;goal&gt;--&gt;</span><br><span class="line">                        &lt;!--&lt;&#x2F;goals&gt;--&gt;</span><br><span class="line">                        &lt;!--&lt;configuration&gt;--&gt;</span><br><span class="line">                            &lt;!--&lt;filters&gt;--&gt;</span><br><span class="line">                                &lt;!--&lt;filter&gt;--&gt;</span><br><span class="line">                                    &lt;!--&lt;!&amp;ndash; Do not copy the signatures in the META-INF folder.--&gt;</span><br><span class="line">                                    &lt;!--Otherwise, this might cause SecurityExceptions when using the JAR. &amp;ndash;&gt;--&gt;</span><br><span class="line">                                    &lt;!--&lt;artifact&gt;*:*&lt;&#x2F;artifact&gt;--&gt;</span><br><span class="line">                                    &lt;!--&lt;excludes&gt;--&gt;</span><br><span class="line">                                        &lt;!--&lt;exclude&gt;META-INF&#x2F;*.SF&lt;&#x2F;exclude&gt;--&gt;</span><br><span class="line">                                        &lt;!--&lt;exclude&gt;META-INF&#x2F;*.DSA&lt;&#x2F;exclude&gt;--&gt;</span><br><span class="line">                                        &lt;!--&lt;exclude&gt;META-INF&#x2F;*.RSA&lt;&#x2F;exclude&gt;--&gt;</span><br><span class="line">                                    &lt;!--&lt;&#x2F;excludes&gt;--&gt;</span><br><span class="line">                                &lt;!--&lt;&#x2F;filter&gt;--&gt;</span><br><span class="line">                            &lt;!--&lt;&#x2F;filters&gt;--&gt;</span><br><span class="line"></span><br><span class="line">                            &lt;!--&lt;createDependencyReducedPom&gt;false&lt;&#x2F;createDependencyReducedPom&gt;--&gt;</span><br><span class="line">                        &lt;!--&lt;&#x2F;configuration&gt;--&gt;</span><br><span class="line">                    &lt;!--&lt;&#x2F;execution&gt;--&gt;</span><br><span class="line">                &lt;!--&lt;&#x2F;executions&gt;--&gt;</span><br><span class="line">            &lt;!--&lt;&#x2F;plugin&gt;--&gt;</span><br><span class="line"></span><br><span class="line">            &lt;!--&lt;plugin&gt;--&gt;</span><br><span class="line">                &lt;!--&lt;groupId&gt;org.apache.maven.plugins&lt;&#x2F;groupId&gt;--&gt;</span><br><span class="line">                &lt;!--&lt;artifactId&gt;maven-compiler-plugin&lt;&#x2F;artifactId&gt;--&gt;</span><br><span class="line">                &lt;!--&lt;configuration&gt;--&gt;</span><br><span class="line">                    &lt;!--&lt;source&gt;1.8&lt;&#x2F;source&gt;--&gt;</span><br><span class="line">                    &lt;!--&lt;target&gt;1.8&lt;&#x2F;target&gt;--&gt;</span><br><span class="line">                &lt;!--&lt;&#x2F;configuration&gt;--&gt;</span><br><span class="line">            &lt;!--&lt;&#x2F;plugin&gt;--&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--&lt;&#x2F;plugins&gt;--&gt;</span><br><span class="line">    &lt;!--&lt;&#x2F;build&gt;--&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;project&gt;</span><br></pre></td></tr></table></figure>

<p>&nbsp;</p>
<p>代码，只是简单的打印了一行日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.bigdata.hive;</span><br><span class="line"></span><br><span class="line">import org.apache.hadoop.hive.ql.hooks.ExecuteWithHookContext;</span><br><span class="line">import org.apache.hadoop.hive.ql.hooks.HookContext;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line">public class MyHiveHook implements ExecuteWithHookContext &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger &#x3D; LoggerFactory.getLogger(MyHiveHook.class);</span><br><span class="line"></span><br><span class="line">    public void run(HookContext hookContext) throws Exception &#123;</span><br><span class="line">        logger.info(&quot;this is my hive hook&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package</span><br></pre></td></tr></table></figure>

<p>将打好的jar包上传到所有hiveserver2所在机器的/var/lib/hive目录下，或者找一个hdfs目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@master:&#x2F;var&#x2F;lib&#x2F;hive# ls</span><br><span class="line">examples.desktop  interview-bigdata-1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure>

<p>修改owner成hive</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown hive:hive .&#x2F;interview-bigdata-1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure>

<p>去cloudera manager中配置hive的辅助jar目录和hook函数</p>
<p>jar目录</p>
<img src="/images/517519-20200321223815028-474591254.png" alt width="600" height="241">

<p>&nbsp;</p>
<p>hook函数，此处配置成hive.exec.pre.hooks，此时添加的hook函数将在sql执行之前运行</p>
<p>&nbsp;<img src="/images/517519-20200321223726000-124218584.png" alt width="1000" height="837"></p>
<p>&nbsp;</p>
<p>第一次配置之后需要重启hive集群，之后替换jar包的时候就只需要在hue中执行reload命令即可</p>
<p>执行sql</p>
<img src="/images/517519-20200321223922239-224576797.png" alt width="900" height="407">

<p>&nbsp;</p>
<p>查看hiveserver2日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -n 100 &#x2F;var&#x2F;log&#x2F;hive&#x2F;hadoop-cmf-hive-HIVESERVER2-master.log.out</span><br></pre></td></tr></table></figure>

<p>可以看到打印的日志</p>
<img src="/images/517519-20200321224111206-227149050.png" alt width="900" height="247">

<p>下面尝试获取一下截取query，并进行打印</p>
<p>参考了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;towardsdatascience.com&#x2F;apache-hive-hooks-and-metastore-listeners-a-tale-of-your-metadata-903b751ee99f</span><br></pre></td></tr></table></figure>

<p>&nbsp;代码，替换jar包的时候需要重启hive才能生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">package com.bigdata.hive;</span><br><span class="line"></span><br><span class="line">import org.apache.hadoop.hive.metastore.api.Database;</span><br><span class="line">import org.apache.hadoop.hive.ql.QueryPlan;</span><br><span class="line">import org.apache.hadoop.hive.ql.hooks.*;</span><br><span class="line">import org.apache.hadoop.hive.ql.plan.HiveOperation;</span><br><span class="line"></span><br><span class="line">import org.codehaus.jackson.map.ObjectMapper;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line">import java.util.HashSet;</span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">public class MyHiveHook implements ExecuteWithHookContext &#123;</span><br><span class="line"></span><br><span class="line">    private static Logger logger &#x3D; LoggerFactory.getLogger(MyHiveHook.class);</span><br><span class="line">    private static final HashSet&lt;String&gt; OPERATION_NAMES &#x3D; new HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.CREATETABLE.getOperationName());</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.ALTERDATABASE.getOperationName());</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.ALTERDATABASE_OWNER.getOperationName());</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.ALTERTABLE_ADDCOLS.getOperationName());</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.ALTERTABLE_LOCATION.getOperationName());</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.ALTERTABLE_PROPERTIES.getOperationName());</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.ALTERTABLE_RENAME.getOperationName());</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.ALTERTABLE_RENAMECOL.getOperationName());</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.ALTERTABLE_REPLACECOLS.getOperationName());</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.CREATEDATABASE.getOperationName());</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.DROPDATABASE.getOperationName());</span><br><span class="line">        OPERATION_NAMES.add(HiveOperation.DROPTABLE.getOperationName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(HookContext hookContext) throws Exception &#123;</span><br><span class="line">        assert (hookContext.getHookType() &#x3D;&#x3D; HookContext.HookType.POST_EXEC_HOOK);</span><br><span class="line"></span><br><span class="line">        QueryPlan plan &#x3D; hookContext.getQueryPlan();</span><br><span class="line"></span><br><span class="line">        String operationName &#x3D; plan.getOperationName();</span><br><span class="line">        logWithHeader(&quot;Query executed: &quot; + plan.getQueryString());</span><br><span class="line">        logWithHeader(&quot;Operation: &quot; + operationName);</span><br><span class="line">        if (OPERATION_NAMES.contains(operationName)</span><br><span class="line">                &amp;&amp; !plan.isExplain()) &#123;</span><br><span class="line">            logWithHeader(&quot;Monitored Operation&quot;);</span><br><span class="line">            Set&lt;ReadEntity&gt; inputs &#x3D; hookContext.getInputs();</span><br><span class="line">            Set&lt;WriteEntity&gt; outputs &#x3D; hookContext.getOutputs();</span><br><span class="line"></span><br><span class="line">            for (Entity entity : inputs) &#123;</span><br><span class="line">                logWithHeader(&quot;Hook metadata input value: &quot; +  toJson(entity));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            for (Entity entity : outputs) &#123;</span><br><span class="line">                logWithHeader(&quot;Hook metadata output value: &quot; +  toJson(entity));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            logWithHeader(&quot;Non-monitored Operation, ignoring hook&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static String toJson(Entity entity) throws Exception &#123;</span><br><span class="line">        ObjectMapper mapper &#x3D; new ObjectMapper();</span><br><span class="line">        switch (entity.getType()) &#123;</span><br><span class="line">            case DATABASE:</span><br><span class="line">                Database db &#x3D; entity.getDatabase();</span><br><span class="line">                return mapper.writeValueAsString(db);</span><br><span class="line">            case TABLE:</span><br><span class="line">                return mapper.writeValueAsString(entity.getTable().getTTable());</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void logWithHeader(Object obj)&#123;</span><br><span class="line">        logger.info(&quot;[CustomHook][Thread: &quot;+Thread.currentThread().getName()+&quot;] | &quot; + obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&nbsp;输出，可以看到select * from test，执行的将会成为两个operation，</p>
<p>一个是SWITCHDATABASE</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2020-03-22 23:50:33,374 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Handler-Pool: Thread-39]: &lt;PERFLOG method&#x3D;PreHook.com.bigdata.hive.MyHiveHook from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-03-22 23:50:33,374 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Handler-Pool: Thread-39]: [CustomHook][Thread: HiveServer2-Handler-Pool: Thread-39] | Query executed: USE &#96;default&#96;</span><br><span class="line">2020-03-22 23:50:33,374 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Handler-Pool: Thread-39]: [CustomHook][Thread: HiveServer2-Handler-Pool: Thread-39] | Operation: SWITCHDATABASE</span><br><span class="line">2020-03-22 23:50:33,374 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Handler-Pool: Thread-39]: [CustomHook][Thread: HiveServer2-Handler-Pool: Thread-39] | Non-monitored Operation, ignoring hook</span><br><span class="line">2020-03-22 23:50:33,375 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Handler-Pool: Thread-39]: &lt;&#x2F;PERFLOG method&#x3D;PreHook.com.bigdata.hive.MyHiveHook start&#x3D;1584892233374 end&#x3D;1584892233375 duration&#x3D;1 from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br></pre></td></tr></table></figure>

<p>&nbsp;一个是QUERY</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2020-03-22 23:50:35,282 INFO  org.apache.hadoop.hive.ql.Driver: [HiveServer2-Background-Pool: Thread-50]: Executing command(queryId&#x3D;hive_20200322235050_83cdb414-52bd-4990-9d20-87f5dc0d76dc): SELECT * from test</span><br><span class="line">2020-03-22 23:50:35,283 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Background-Pool: Thread-50]: &lt;PERFLOG method&#x3D;PreHook.com.bigdata.hive.MyHiveHook from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-03-22 23:50:35,283 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-50]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-50] | Query executed: SELECT * from test</span><br><span class="line">2020-03-22 23:50:35,283 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-50]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-50] | Operation: QUERY</span><br><span class="line">2020-03-22 23:50:35,283 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-50]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-50] | Non-monitored Operation, ignoring hook</span><br><span class="line">2020-03-22 23:50:35,283 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Background-Pool: Thread-50]: &lt;&#x2F;PERFLOG method&#x3D;PreHook.com.bigdata.hive.MyHiveHook start&#x3D;1584892235283 end&#x3D;1584892235283 duration&#x3D;0 from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br></pre></td></tr></table></figure>

<p>如果执行的是建表语句，比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;test1&#96;(</span><br><span class="line">	  &#96;id&#96; int, </span><br><span class="line">	  &#96;name&#96; string)</span><br><span class="line">	ROW FORMAT SERDE </span><br><span class="line">	  &#39;org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe&#39; </span><br><span class="line">	STORED AS INPUTFORMAT </span><br><span class="line">	  &#39;org.apache.hadoop.mapred.TextInputFormat&#39; </span><br><span class="line">	OUTPUTFORMAT </span><br><span class="line">	  &#39;org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat&#39;</span><br><span class="line">	LOCATION</span><br><span class="line">	  &#39;hdfs:&#x2F;&#x2F;master:8020&#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;test&#39;</span><br><span class="line">	TBLPROPERTIES (</span><br><span class="line">	  &#39;COLUMN_STATS_ACCURATE&#39;&#x3D;&#39;true&#39;, </span><br><span class="line">	  &#39;numFiles&#39;&#x3D;&#39;3&#39;, </span><br><span class="line">	  &#39;numRows&#39;&#x3D;&#39;6&#39;, </span><br><span class="line">	  &#39;rawDataSize&#39;&#x3D;&#39;36&#39;, </span><br><span class="line">	  &#39;totalSize&#39;&#x3D;&#39;42&#39;, </span><br><span class="line">	  &#39;transient_lastDdlTime&#39;&#x3D;&#39;1584893066&#39;)</span><br></pre></td></tr></table></figure>

<p>那么hook函数的输出将会是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">2020-03-23 00:08:16,486 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Background-Pool: Thread-94]: &lt;PERFLOG method&#x3D;PreHook.com.bigdata.hive.MyHiveHook from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-03-23 00:08:16,486 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-94]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-94] | Query executed: CREATE TABLE &#96;test1&#96;(</span><br><span class="line">          &#96;id&#96; int,</span><br><span class="line">          &#96;name&#96; string)</span><br><span class="line">        ROW FORMAT SERDE</span><br><span class="line">          &#39;org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe&#39;</span><br><span class="line">        STORED AS INPUTFORMAT</span><br><span class="line">          &#39;org.apache.hadoop.mapred.TextInputFormat&#39;</span><br><span class="line">        OUTPUTFORMAT</span><br><span class="line">          &#39;org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat&#39;</span><br><span class="line">        LOCATION</span><br><span class="line">          &#39;hdfs:&#x2F;&#x2F;master:8020&#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;test&#39;</span><br><span class="line">        TBLPROPERTIES (</span><br><span class="line">          &#39;COLUMN_STATS_ACCURATE&#39;&#x3D;&#39;true&#39;,</span><br><span class="line">          &#39;numFiles&#39;&#x3D;&#39;3&#39;,</span><br><span class="line">          &#39;numRows&#39;&#x3D;&#39;6&#39;,</span><br><span class="line">          &#39;rawDataSize&#39;&#x3D;&#39;36&#39;,</span><br><span class="line">          &#39;totalSize&#39;&#x3D;&#39;42&#39;,</span><br><span class="line">          &#39;transient_lastDdlTime&#39;&#x3D;&#39;1584893066&#39;)</span><br><span class="line">2020-03-23 00:08:16,486 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-94]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-94] | Operation: CREATETABLE</span><br><span class="line">2020-03-23 00:08:16,486 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-94]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-94] | Monitored Operation</span><br><span class="line">2020-03-23 00:08:16,487 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-94]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-94] | Hook metadata input value: null</span><br><span class="line">2020-03-23 00:08:16,497 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-94]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-94] | Hook metadata output value: &#123;&quot;description&quot;:&quot;Default Hive database&quot;,&quot;name&quot;:&quot;default&quot;,&quot;parameters&quot;:&#123;&#125;,&quot;ownerType&quot;:&quot;ROLE&quot;,&quot;setName&quot;:true,&quot;setDescription&quot;:true,&quot;locationUri&quot;:&quot;hdfs:&#x2F;&#x2F;master:8020&#x2F;user&#x2F;hive&#x2F;warehouse&quot;,&quot;setLocationUri&quot;:true,&quot;setOwnerName&quot;:true,&quot;ownerName&quot;:&quot;public&quot;,&quot;setPrivileges&quot;:false,&quot;setOwnerType&quot;:true,&quot;parametersSize&quot;:0,&quot;setParameters&quot;:true,&quot;privileges&quot;:null&#125;</span><br><span class="line">2020-03-23 00:08:16,519 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-94]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-94] | Hook metadata output value: &#123;&quot;lastAccessTime&quot;:0,&quot;parameters&quot;:&#123;&#125;,&quot;owner&quot;:&quot;hive&quot;,&quot;ownerType&quot;:&quot;USER&quot;,&quot;dbName&quot;:&quot;default&quot;,&quot;tableType&quot;:&quot;MANAGED_TABLE&quot;,&quot;tableName&quot;:&quot;test1&quot;,&quot;setTableName&quot;:true,&quot;setOwner&quot;:true,&quot;retention&quot;:0,&quot;setRetention&quot;:false,&quot;partitionKeysSize&quot;:0,&quot;partitionKeysIterator&quot;:[],&quot;setPartitionKeys&quot;:true,&quot;viewOriginalText&quot;:null,&quot;setViewOriginalText&quot;:false,&quot;viewExpandedText&quot;:null,&quot;setViewExpandedText&quot;:false,&quot;setTableType&quot;:true,&quot;setPrivileges&quot;:false,&quot;setTemporary&quot;:false,&quot;setOwnerType&quot;:true,&quot;setDbName&quot;:true,&quot;createTime&quot;:1584893296,&quot;setCreateTime&quot;:true,&quot;setLastAccessTime&quot;:false,&quot;setSd&quot;:true,&quot;parametersSize&quot;:0,&quot;setParameters&quot;:true,&quot;privileges&quot;:null,&quot;sd&quot;:&#123;&quot;location&quot;:null,&quot;parameters&quot;:&#123;&#125;,&quot;numBuckets&quot;:-1,&quot;inputFormat&quot;:&quot;org.apache.hadoop.mapred.SequenceFileInputFormat&quot;,&quot;outputFormat&quot;:&quot;org.apache.hadoop.hive.ql.io.HiveSequenceFileOutputFormat&quot;,&quot;compressed&quot;:false,&quot;sortCols&quot;:[],&quot;parametersSize&quot;:0,&quot;setParameters&quot;:true,&quot;cols&quot;:[],&quot;colsSize&quot;:0,&quot;serdeInfo&quot;:&#123;&quot;setSerializationLib&quot;:true,&quot;name&quot;:null,&quot;parameters&quot;:&#123;&quot;serialization.format&quot;:&quot;1&quot;&#125;,&quot;setName&quot;:false,&quot;parametersSize&quot;:1,&quot;setParameters&quot;:true,&quot;serializationLib&quot;:&quot;org.apache.hadoop.hive.serde2.MetadataTypedColumnsetSerDe&quot;&#125;,&quot;skewedInfo&quot;:&#123;&quot;skewedColNamesSize&quot;:0,&quot;skewedColNamesIterator&quot;:[],&quot;setSkewedColNames&quot;:true,&quot;skewedColValuesSize&quot;:0,&quot;skewedColValuesIterator&quot;:[],&quot;setSkewedColValues&quot;:true,&quot;skewedColValueLocationMapsSize&quot;:0,&quot;setSkewedColValueLocationMaps&quot;:true,&quot;skewedColValueLocationMaps&quot;:&#123;&#125;,&quot;skewedColNames&quot;:[],&quot;skewedColValues&quot;:[]&#125;,&quot;bucketCols&quot;:[],&quot;setNumBuckets&quot;:true,&quot;setSerdeInfo&quot;:true,&quot;bucketColsSize&quot;:0,&quot;bucketColsIterator&quot;:[],&quot;setBucketCols&quot;:true,&quot;sortColsSize&quot;:0,&quot;sortColsIterator&quot;:[],&quot;setSortCols&quot;:true,&quot;setSkewedInfo&quot;:true,&quot;storedAsSubDirectories&quot;:false,&quot;setStoredAsSubDirectories&quot;:false,&quot;colsIterator&quot;:[],&quot;setCols&quot;:true,&quot;setLocation&quot;:false,&quot;setInputFormat&quot;:true,&quot;setOutputFormat&quot;:true,&quot;setCompressed&quot;:false&#125;,&quot;temporary&quot;:false,&quot;partitionKeys&quot;:[]&#125;</span><br><span class="line">2020-03-23 00:08:16,519 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Background-Pool: Thread-94]: &lt;&#x2F;PERFLOG method&#x3D;PreHook.com.bigdata.hive.MyHiveHook start&#x3D;1584893296486 end&#x3D;1584893296519 duration&#x3D;33 from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-03-23 00:08:16,519 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Background-Pool: Thread-94]: &lt;&#x2F;PERFLOG method&#x3D;TimeToSubmit start&#x3D;1584893296477 end&#x3D;1584893296519 duration&#x3D;42 from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br></pre></td></tr></table></figure>

<p>如果执行的是修改字段的语句，比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE test1 CHANGE id id String COMMENT &quot;test&quot;</span><br></pre></td></tr></table></figure>

<p>那么hook函数的输出会是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2020-03-28 14:19:12,912 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Handler-Pool: Thread-39]: &lt;&#x2F;PERFLOG method&#x3D;compile start&#x3D;1585376352892 end&#x3D;1585376352912 duration&#x3D;20 from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-03-28 14:19:12,912 INFO  org.apache.hadoop.hive.ql.Driver: [HiveServer2-Handler-Pool: Thread-39]: Completed compiling command(queryId&#x3D;hive_20200328141919_d2739f08-478e-4f95-949b-e0bd176e4eab); Time taken: 0.02 seconds</span><br><span class="line">2020-03-28 14:19:12,913 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Background-Pool: Thread-79]: &lt;PERFLOG method&#x3D;Driver.run from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-03-28 14:19:12,913 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Background-Pool: Thread-79]: &lt;PERFLOG method&#x3D;TimeToSubmit from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-03-28 14:19:12,913 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Background-Pool: Thread-79]: &lt;PERFLOG method&#x3D;acquireReadWriteLocks from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-03-28 14:19:12,922 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Background-Pool: Thread-79]: &lt;&#x2F;PERFLOG method&#x3D;acquireReadWriteLocks start&#x3D;1585376352913 end&#x3D;1585376352922 duration&#x3D;9 from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-03-28 14:19:12,922 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Background-Pool: Thread-79]: &lt;PERFLOG method&#x3D;Driver.execute from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-03-28 14:19:12,922 INFO  org.apache.hadoop.hive.ql.Driver: [HiveServer2-Background-Pool: Thread-79]: Executing command(queryId&#x3D;hive_20200328141919_d2739f08-478e-4f95-949b-e0bd176e4eab): ALTER TABLE test1 CHANGE id id String COMMENT &quot;test&quot;</span><br><span class="line">2020-03-28 14:19:12,923 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Background-Pool: Thread-79]: &lt;PERFLOG method&#x3D;PreHook.com.bigdata.hive.MyHiveHook from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-03-28 14:19:12,923 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-79]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-79] | Query executed: ALTER TABLE test1 CHANGE id id String COMMENT &quot;test&quot;</span><br><span class="line">2020-03-28 14:19:12,923 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-79]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-79] | Operation: ALTERTABLE_RENAMECOL</span><br><span class="line">2020-03-28 14:19:12,923 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-79]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-79] | Monitored Operation</span><br><span class="line">2020-03-28 14:19:12,928 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-79]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-79] | Hook metadata input value: &#123;&quot;lastAccessTime&quot;:0,&quot;ownerType&quot;:&quot;USER&quot;,&quot;parameters&quot;:&#123;&quot;last_modified_time&quot;:&quot;1585376257&quot;,&quot;totalSize&quot;:&quot;0&quot;,&quot;numRows&quot;:&quot;-1&quot;,&quot;rawDataSize&quot;:&quot;-1&quot;,&quot;COLUMN_STATS_ACCURATE&quot;:&quot;false&quot;,&quot;numFiles&quot;:&quot;0&quot;,&quot;transient_lastDdlTime&quot;:&quot;1585376257&quot;,&quot;last_modified_by&quot;:&quot;hive&quot;&#125;,&quot;owner&quot;:&quot;hive&quot;,&quot;tableName&quot;:&quot;test1&quot;,&quot;dbName&quot;:&quot;default&quot;,&quot;tableType&quot;:&quot;MANAGED_TABLE&quot;,&quot;privileges&quot;:null,&quot;sd&quot;:&#123;&quot;location&quot;:&quot;hdfs:&#x2F;&#x2F;master:8020&#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;test&quot;,&quot;parameters&quot;:&#123;&#125;,&quot;inputFormat&quot;:&quot;org.apache.hadoop.mapred.TextInputFormat&quot;,&quot;outputFormat&quot;:&quot;org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat&quot;,&quot;compressed&quot;:false,&quot;numBuckets&quot;:-1,&quot;sortCols&quot;:[],&quot;cols&quot;:[&#123;&quot;comment&quot;:&quot;test&quot;,&quot;name&quot;:&quot;id&quot;,&quot;type&quot;:&quot;string&quot;,&quot;setName&quot;:true,&quot;setType&quot;:true,&quot;setComment&quot;:true&#125;,&#123;&quot;comment&quot;:null,&quot;name&quot;:&quot;name&quot;,&quot;type&quot;:&quot;string&quot;,&quot;setName&quot;:true,&quot;setType&quot;:true,&quot;setComment&quot;:false&#125;],&quot;colsSize&quot;:2,&quot;serdeInfo&quot;:&#123;&quot;setSerializationLib&quot;:true,&quot;name&quot;:null,&quot;parameters&quot;:&#123;&quot;serialization.format&quot;:&quot;1&quot;&#125;,&quot;serializationLib&quot;:&quot;org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe&quot;,&quot;parametersSize&quot;:1,&quot;setParameters&quot;:true,&quot;setName&quot;:false&#125;,&quot;skewedInfo&quot;:&#123;&quot;skewedColNamesSize&quot;:0,&quot;skewedColNamesIterator&quot;:[],&quot;setSkewedColNames&quot;:true,&quot;skewedColValuesSize&quot;:0,&quot;skewedColValuesIterator&quot;:[],&quot;setSkewedColValues&quot;:true,&quot;skewedColValueLocationMapsSize&quot;:0,&quot;setSkewedColValueLocationMaps&quot;:true,&quot;skewedColValueLocationMaps&quot;:&#123;&#125;,&quot;skewedColNames&quot;:[],&quot;skewedColValues&quot;:[]&#125;,&quot;bucketCols&quot;:[],&quot;parametersSize&quot;:0,&quot;setParameters&quot;:true,&quot;colsIterator&quot;:[&#123;&quot;comment&quot;:&quot;test&quot;,&quot;name&quot;:&quot;id&quot;,&quot;type&quot;:&quot;string&quot;,&quot;setName&quot;:true,&quot;setType&quot;:true,&quot;setComment&quot;:true&#125;,&#123;&quot;comment&quot;:null,&quot;name&quot;:&quot;name&quot;,&quot;type&quot;:&quot;string&quot;,&quot;setName&quot;:true,&quot;setType&quot;:true,&quot;setComment&quot;:false&#125;],&quot;setCols&quot;:true,&quot;setLocation&quot;:true,&quot;setInputFormat&quot;:true,&quot;setOutputFormat&quot;:true,&quot;setCompressed&quot;:true,&quot;setNumBuckets&quot;:true,&quot;setSerdeInfo&quot;:true,&quot;bucketColsSize&quot;:0,&quot;bucketColsIterator&quot;:[],&quot;setBucketCols&quot;:true,&quot;sortColsSize&quot;:0,&quot;sortColsIterator&quot;:[],&quot;setSortCols&quot;:true,&quot;setSkewedInfo&quot;:true,&quot;storedAsSubDirectories&quot;:false,&quot;setStoredAsSubDirectories&quot;:true&#125;,&quot;temporary&quot;:false,&quot;partitionKeys&quot;:[],&quot;setTableName&quot;:true,&quot;setOwner&quot;:true,&quot;retention&quot;:0,&quot;setRetention&quot;:true,&quot;partitionKeysSize&quot;:0,&quot;partitionKeysIterator&quot;:[],&quot;setPartitionKeys&quot;:true,&quot;viewOriginalText&quot;:null,&quot;setViewOriginalText&quot;:false,&quot;viewExpandedText&quot;:null,&quot;setViewExpandedText&quot;:false,&quot;setTableType&quot;:true,&quot;setPrivileges&quot;:false,&quot;setTemporary&quot;:false,&quot;setOwnerType&quot;:true,&quot;setDbName&quot;:true,&quot;createTime&quot;:1584893296,&quot;setCreateTime&quot;:true,&quot;setLastAccessTime&quot;:true,&quot;setSd&quot;:true,&quot;parametersSize&quot;:8,&quot;setParameters&quot;:true&#125;</span><br><span class="line">2020-03-28 14:19:12,935 INFO  com.bigdata.hive.MyHiveHook: [HiveServer2-Background-Pool: Thread-79]: [CustomHook][Thread: HiveServer2-Background-Pool: Thread-79] | Hook metadata output value: &#123;&quot;lastAccessTime&quot;:0,&quot;ownerType&quot;:&quot;USER&quot;,&quot;parameters&quot;:&#123;&quot;last_modified_time&quot;:&quot;1585376257&quot;,&quot;totalSize&quot;:&quot;0&quot;,&quot;numRows&quot;:&quot;-1&quot;,&quot;rawDataSize&quot;:&quot;-1&quot;,&quot;COLUMN_STATS_ACCURATE&quot;:&quot;false&quot;,&quot;numFiles&quot;:&quot;0&quot;,&quot;transient_lastDdlTime&quot;:&quot;1585376257&quot;,&quot;last_modified_by&quot;:&quot;hive&quot;&#125;,&quot;owner&quot;:&quot;hive&quot;,&quot;tableName&quot;:&quot;test1&quot;,&quot;dbName&quot;:&quot;default&quot;,&quot;tableType&quot;:&quot;MANAGED_TABLE&quot;,&quot;privileges&quot;:null,&quot;sd&quot;:&#123;&quot;location&quot;:&quot;hdfs:&#x2F;&#x2F;master:8020&#x2F;user&#x2F;hive&#x2F;warehouse&#x2F;test&quot;,&quot;parameters&quot;:&#123;&#125;,&quot;inputFormat&quot;:&quot;org.apache.hadoop.mapred.TextInputFormat&quot;,&quot;outputFormat&quot;:&quot;org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat&quot;,&quot;compressed&quot;:false,&quot;numBuckets&quot;:-1,&quot;sortCols&quot;:[],&quot;cols&quot;:[&#123;&quot;comment&quot;:&quot;test&quot;,&quot;name&quot;:&quot;id&quot;,&quot;type&quot;:&quot;string&quot;,&quot;setName&quot;:true,&quot;setType&quot;:true,&quot;setComment&quot;:true&#125;,&#123;&quot;comment&quot;:null,&quot;name&quot;:&quot;name&quot;,&quot;type&quot;:&quot;string&quot;,&quot;setName&quot;:true,&quot;setType&quot;:true,&quot;setComment&quot;:false&#125;],&quot;colsSize&quot;:2,&quot;serdeInfo&quot;:&#123;&quot;setSerializationLib&quot;:true,&quot;name&quot;:null,&quot;parameters&quot;:&#123;&quot;serialization.format&quot;:&quot;1&quot;&#125;,&quot;serializationLib&quot;:&quot;org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe&quot;,&quot;parametersSize&quot;:1,&quot;setParameters&quot;:true,&quot;setName&quot;:false&#125;,&quot;skewedInfo&quot;:&#123;&quot;skewedColNamesSize&quot;:0,&quot;skewedColNamesIterator&quot;:[],&quot;setSkewedColNames&quot;:true,&quot;skewedColValuesSize&quot;:0,&quot;skewedColValuesIterator&quot;:[],&quot;setSkewedColValues&quot;:true,&quot;skewedColValueLocationMapsSize&quot;:0,&quot;setSkewedColValueLocationMaps&quot;:true,&quot;skewedColValueLocationMaps&quot;:&#123;&#125;,&quot;skewedColNames&quot;:[],&quot;skewedColValues&quot;:[]&#125;,&quot;bucketCols&quot;:[],&quot;parametersSize&quot;:0,&quot;setParameters&quot;:true,&quot;colsIterator&quot;:[&#123;&quot;comment&quot;:&quot;test&quot;,&quot;name&quot;:&quot;id&quot;,&quot;type&quot;:&quot;string&quot;,&quot;setName&quot;:true,&quot;setType&quot;:true,&quot;setComment&quot;:true&#125;,&#123;&quot;comment&quot;:null,&quot;name&quot;:&quot;name&quot;,&quot;type&quot;:&quot;string&quot;,&quot;setName&quot;:true,&quot;setType&quot;:true,&quot;setComment&quot;:false&#125;],&quot;setCols&quot;:true,&quot;setLocation&quot;:true,&quot;setInputFormat&quot;:true,&quot;setOutputFormat&quot;:true,&quot;setCompressed&quot;:true,&quot;setNumBuckets&quot;:true,&quot;setSerdeInfo&quot;:true,&quot;bucketColsSize&quot;:0,&quot;bucketColsIterator&quot;:[],&quot;setBucketCols&quot;:true,&quot;sortColsSize&quot;:0,&quot;sortColsIterator&quot;:[],&quot;setSortCols&quot;:true,&quot;setSkewedInfo&quot;:true,&quot;storedAsSubDirectories&quot;:false,&quot;setStoredAsSubDirectories&quot;:true&#125;,&quot;temporary&quot;:false,&quot;partitionKeys&quot;:[],&quot;setTableName&quot;:true,&quot;setOwner&quot;:true,&quot;retention&quot;:0,&quot;setRetention&quot;:true,&quot;partitionKeysSize&quot;:0,&quot;partitionKeysIterator&quot;:[],&quot;setPartitionKeys&quot;:true,&quot;viewOriginalText&quot;:null,&quot;setViewOriginalText&quot;:false,&quot;viewExpandedText&quot;:null,&quot;setViewExpandedText&quot;:false,&quot;setTableType&quot;:true,&quot;setPrivileges&quot;:false,&quot;setTemporary&quot;:false,&quot;setOwnerType&quot;:true,&quot;setDbName&quot;:true,&quot;createTime&quot;:1584893296,&quot;setCreateTime&quot;:true,&quot;setLastAccessTime&quot;:true,&quot;setSd&quot;:true,&quot;parametersSize&quot;:8,&quot;setParameters&quot;:true&#125;</span><br></pre></td></tr></table></figure>

<p>&nbsp;</p>
<p><strong>2.HiveSemanticAnalyzerHook接口</strong></p>
<p><strong>参考：<a href="https://www.iteye.com/blog/crazymatrix-2092830" target="_blank" rel="noopener">https://www.iteye.com/blog/crazymatrix-2092830</a></strong></p>
<p>实现HiveSemanticAnalyzerHook接口可以在hive执行语法分析前后插入hook函数，即preAnalyze和postAnalyze</p>
<p>有时，用户写的sql会带有上下文，比如select * from test，这时test这张表会属于用户当前session中的某个库，比如use default，可以使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private final SessionState ss &#x3D; SessionState.get();</span><br></pre></td></tr></table></figure>

<p>&nbsp;来获得当前用户session中的库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">package com.bigdata.hive;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.lang.StringUtils;</span><br><span class="line">import org.apache.hadoop.hive.metastore.api.FieldSchema;</span><br><span class="line">import org.apache.hadoop.hive.ql.exec.Task;</span><br><span class="line">import org.apache.hadoop.hive.ql.metadata.Hive;</span><br><span class="line">import org.apache.hadoop.hive.ql.metadata.HiveException;</span><br><span class="line">import org.apache.hadoop.hive.ql.metadata.Table;</span><br><span class="line">import org.apache.hadoop.hive.ql.parse.*;</span><br><span class="line">import org.apache.hadoop.hive.ql.session.SessionState;</span><br><span class="line">import org.apache.hadoop.hive.ql.session.SessionState.LogHelper;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line">public class MyHiveHook2 implements HiveSemanticAnalyzerHook &#123;</span><br><span class="line"></span><br><span class="line">    private final static String NO_PARTITION_WARNING &#x3D; &quot;WARNING: HQL is not efficient, Please specify partition condition! HQL:%s ;USERNAME:%s&quot;;</span><br><span class="line"></span><br><span class="line">    private final SessionState ss &#x3D; SessionState.get();</span><br><span class="line">    private final LogHelper console &#x3D; SessionState.getConsole();</span><br><span class="line">    private Hive hive &#x3D; null;</span><br><span class="line">    private String username;</span><br><span class="line">    private String currentDatabase &#x3D; &quot;default&quot;;</span><br><span class="line">    private String hql;</span><br><span class="line">    private String whereHql;</span><br><span class="line">    private String tableAlias;</span><br><span class="line">    private String tableName;</span><br><span class="line">    private String tableDatabaseName;</span><br><span class="line">    private Boolean needCheckPartition &#x3D; false;</span><br><span class="line"></span><br><span class="line">    private static Logger logger &#x3D; LoggerFactory.getLogger(MyHiveHook2.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ASTNode preAnalyze(HiveSemanticAnalyzerHookContext context, ASTNode ast) throws SemanticException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            logger.info(context.getCommand()); &#x2F;&#x2F; 当前query</span><br><span class="line">            logger.info(ss.getUserName());  &#x2F;&#x2F; 当前user</span><br><span class="line">            hql &#x3D; StringUtils.replaceChars(context.getCommand(), &#39;\n&#39;, &#39; &#39;);</span><br><span class="line">            logger.info(&quot;hql: &quot; + hql);</span><br><span class="line">            if (hql.contains(&quot;where&quot;)) &#123;</span><br><span class="line">                whereHql &#x3D; hql.substring(hql.indexOf(&quot;where&quot;));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            username &#x3D; context.getUserName();</span><br><span class="line">            logger.info(ast.getToken().getText()); &#x2F;&#x2F; TOK_QUERY</span><br><span class="line">            logger.info(String.valueOf(ast.getToken().getType())); &#x2F;&#x2F; token code</span><br><span class="line">            logger.info(&quot;&quot; + (ast.getToken().getType() &#x3D;&#x3D; HiveParser.TOK_QUERY));</span><br><span class="line">            if (ast.getToken().getType() &#x3D;&#x3D; HiveParser.TOK_QUERY) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    hive &#x3D; context.getHive();</span><br><span class="line"></span><br><span class="line">                    currentDatabase &#x3D; hive.getDatabaseCurrent().getName();</span><br><span class="line">                    logger.info(&quot;current database: &quot; + currentDatabase); &#x2F;&#x2F; session db</span><br><span class="line">                &#125; catch (HiveException e) &#123;</span><br><span class="line">                    throw new SemanticException(e);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                extractFromClause((ASTNode) ast.getChild(0));</span><br><span class="line"></span><br><span class="line">                String dbname &#x3D; StringUtils.isEmpty(tableDatabaseName) ? currentDatabase : tableDatabaseName;</span><br><span class="line">                String tbname &#x3D; tableName;</span><br><span class="line"></span><br><span class="line">                String[] parts &#x3D; tableName.split(&quot;.&quot;);</span><br><span class="line">                if (parts.length &#x3D;&#x3D; 2) &#123;</span><br><span class="line">                    dbname &#x3D; parts[0];</span><br><span class="line">                    tbname &#x3D; parts[1];</span><br><span class="line">                &#125;</span><br><span class="line">                logger.info(&quot;this is hive database name: &quot; + dbname); &#x2F;&#x2F; current db</span><br><span class="line">                logger.info(&quot;this is hive table name: &quot; + tbname);  &#x2F;&#x2F; current table</span><br><span class="line">                Table t &#x3D; hive.getTable(dbname, tbname);</span><br><span class="line">                if (t.isPartitioned()) &#123;</span><br><span class="line">                    if (StringUtils.isBlank(whereHql)) &#123;</span><br><span class="line">                        console.printError(String.format(NO_PARTITION_WARNING, hql, username));</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        List&lt;FieldSchema&gt; partitionKeys &#x3D; t.getPartitionKeys();</span><br><span class="line">                        List&lt;String&gt; partitionNames &#x3D; new ArrayList&lt;String&gt;();</span><br><span class="line">                        for (int i &#x3D; 0; i &lt; partitionKeys.size(); i++) &#123;</span><br><span class="line">                            partitionNames.add(partitionKeys.get(i).getName().toLowerCase());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        if (!containsPartCond(partitionNames, whereHql, tableAlias)) &#123;</span><br><span class="line">                            console.printError(String.format(NO_PARTITION_WARNING, hql, username));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception ex) &#123;</span><br><span class="line">            logger.info(&quot;error: &quot;, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        return ast;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean containsPartCond(List&lt;String&gt; partitionKeys, String sql, String alias) &#123;</span><br><span class="line">        for (String pk : partitionKeys) &#123;</span><br><span class="line">            if (sql.contains(pk)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">            if (!StringUtils.isEmpty(alias) &amp;&amp; sql.contains(alias + &quot;.&quot; + pk)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void extractFromClause(ASTNode ast) &#123;</span><br><span class="line">        if (HiveParser.TOK_FROM &#x3D;&#x3D; ast.getToken().getType()) &#123;</span><br><span class="line">            ASTNode refNode &#x3D; (ASTNode) ast.getChild(0);</span><br><span class="line">            if (refNode.getToken().getType() &#x3D;&#x3D; HiveParser.TOK_TABREF &amp;&amp; ast.getChildCount() &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                ASTNode tabNameNode &#x3D; (ASTNode) (refNode.getChild(0));</span><br><span class="line">                int refNodeChildCount &#x3D; refNode.getChildCount();</span><br><span class="line">                if (tabNameNode.getToken().getType() &#x3D;&#x3D; HiveParser.TOK_TABNAME) &#123;</span><br><span class="line">                    if (tabNameNode.getChildCount() &#x3D;&#x3D; 2) &#123;</span><br><span class="line">                        tableDatabaseName &#x3D; tabNameNode.getChild(0).getText().toLowerCase();</span><br><span class="line">                        tableName &#x3D; BaseSemanticAnalyzer.getUnescapedName((ASTNode) tabNameNode.getChild(1))</span><br><span class="line">                                .toLowerCase();</span><br><span class="line">                    &#125; else if (tabNameNode.getChildCount() &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                        tableName &#x3D; BaseSemanticAnalyzer.getUnescapedName((ASTNode) tabNameNode.getChild(0))</span><br><span class="line">                                .toLowerCase();</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (refNodeChildCount &#x3D;&#x3D; 2) &#123;</span><br><span class="line">                        tableAlias &#x3D; BaseSemanticAnalyzer.unescapeIdentifier(refNode.getChild(1).getText())</span><br><span class="line">                                .toLowerCase();</span><br><span class="line">                    &#125;</span><br><span class="line">                    needCheckPartition &#x3D; true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void postAnalyze(HiveSemanticAnalyzerHookContext context,</span><br><span class="line">                            List&lt;Task&lt;? extends Serializable&gt;&gt; rootTasks) throws SemanticException &#123;</span><br><span class="line">        logger.info(context.getCommand());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&nbsp;输出是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">2020-04-01 00:41:41,485 INFO  org.apache.hadoop.hive.ql.Driver: [HiveServer2-Handler-Pool: Thread-39]: Compiling command(queryId&#x3D;hive_20200401004141_bf4c578a-6872-4947-8396-7c11b0530539): select * from test</span><br><span class="line">2020-04-01 00:41:41,486 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Handler-Pool: Thread-39]: &lt;PERFLOG method&#x3D;parse from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-04-01 00:41:41,501 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Handler-Pool: Thread-39]: &lt;&#x2F;PERFLOG method&#x3D;parse start&#x3D;1585672901486 end&#x3D;1585672901501 duration&#x3D;15 from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-04-01 00:41:41,502 INFO  org.apache.hadoop.hive.ql.log.PerfLogger: [HiveServer2-Handler-Pool: Thread-39]: &lt;PERFLOG method&#x3D;semanticAnalyze from&#x3D;org.apache.hadoop.hive.ql.Driver&gt;</span><br><span class="line">2020-04-01 00:41:41,550 INFO  com.bigdata.hive.MyHiveHook2: [HiveServer2-Handler-Pool: Thread-39]: select * from test</span><br><span class="line">2020-04-01 00:41:41,551 INFO  com.bigdata.hive.MyHiveHook2: [HiveServer2-Handler-Pool: Thread-39]: hive</span><br><span class="line">2020-04-01 00:41:41,551 INFO  com.bigdata.hive.MyHiveHook2: [HiveServer2-Handler-Pool: Thread-39]: hql: select * from test</span><br><span class="line">2020-04-01 00:41:41,551 INFO  com.bigdata.hive.MyHiveHook2: [HiveServer2-Handler-Pool: Thread-39]: TOK_QUERY</span><br><span class="line">2020-04-01 00:41:41,551 INFO  com.bigdata.hive.MyHiveHook2: [HiveServer2-Handler-Pool: Thread-39]: 789</span><br><span class="line">2020-04-01 00:41:41,551 INFO  com.bigdata.hive.MyHiveHook2: [HiveServer2-Handler-Pool: Thread-39]: true</span><br><span class="line">2020-04-01 00:41:41,561 INFO  com.bigdata.hive.MyHiveHook2: [HiveServer2-Handler-Pool: Thread-39]: current database: default</span><br><span class="line">2020-04-01 00:41:41,561 INFO  com.bigdata.hive.MyHiveHook2: [HiveServer2-Handler-Pool: Thread-39]: this is hive database name: default</span><br><span class="line">2020-04-01 00:41:41,561 INFO  com.bigdata.hive.MyHiveHook2: [HiveServer2-Handler-Pool: Thread-39]: this is hive table name: test</span><br><span class="line">2020-04-01 00:41:41,621 INFO  org.apache.hadoop.hive.ql.parse.SemanticAnalyzer: [HiveServer2-Handler-Pool: Thread-39]: Starting Semantic Analysis</span><br><span class="line">2020-04-01 00:41:41,623 INFO  org.apache.hadoop.hive.ql.parse.SemanticAnalyzer: [HiveServer2-Handler-Pool: Thread-39]: Completed phase 1 of Semantic Analysis</span><br><span class="line">2020-04-01 00:41:41,623 INFO  org.apache.hadoop.hive.ql.parse.SemanticAnalyzer: [HiveServer2-Handler-Pool: Thread-39]: Get metadata for source tables</span><br><span class="line">2020-04-01 00:41:41,648 INFO  org.apache.hadoop.hive.ql.parse.SemanticAnalyzer: [HiveServer2-Handler-Pool: Thread-39]: Get metadata for subqueries</span><br><span class="line">2020-04-01 00:41:41,656 INFO  org.apache.hadoop.hive.ql.parse.SemanticAnalyzer: [HiveServer2-Handler-Pool: Thread-39]: Get metadata for destination tables</span><br><span class="line">2020-04-01 00:41:41,708 INFO  hive.ql.Context: [HiveServer2-Handler-Pool: Thread-39]: New scratch dir is hdfs:&#x2F;&#x2F;master:8020&#x2F;tmp&#x2F;hive&#x2F;hive&#x2F;3fc884ec-0f81-49e7-ae87-45ce85ca4139&#x2F;hive_2020-04-01_00-41-41_485_2813780198360550808-1</span><br><span class="line">2020-04-01 00:41:41,710 INFO  org.apache.hadoop.hive.ql.parse.SemanticAnalyzer: [HiveServer2-Handler-Pool: Thread-39]: Completed getting MetaData in Semantic Analysis</span><br></pre></td></tr></table></figure>

<p>&nbsp;</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://tonglin0325.github.io/2020/03/21/Hive%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94hive%20hook/" data-id="ckca3uxyk001vw20l93ar76e9" class="article-share-link">
        <i class="fa fa-share"></i> 分享
      </a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hive/" rel="tag">Hive</a></li></ul>


    </footer>
  </div>
  
    
<ul id="article-nav" class="nav nav-pills nav-justified">
  
  <li role="presentation">
    <a href="/2020/03/15/Flink%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E8%AF%BB%E5%86%99kafka/" id="article-nav-older" class="article-nav-link-wrap">
      <i class="fa fa-chevron-left pull-left"></i>
      <span class="article-nav-link-title">Flink学习笔记——读写kafka</span>
    </a>
  </li>
  
  
  <li role="presentation">
    <a href="/2020/04/09/Python%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94sqlalchemy/" id="article-nav-newer" class="article-nav-link-wrap">
      <span class="article-nav-link-title">Python学习笔记——sqlalchemy</span>
      <i class="fa fa-chevron-right pull-right"></i>
    </a>
  </li>
  
</ul>


  
</article>




        </div>
        <div class="col-sm-3 col-sm-offset-0 blog-sidebar">
          
  <div class="sidebar-module sidebar-module-inset">
  <h4>tonglin0325</h4>
  <div style="text-align:center;"><img src="/images/WechatIMG1.jpeg" width="150" height="150" style="vertical-align:middle;"/></div>
</div>


  


  
  <div class="sidebar-module">
    <h4>标签</h4>
    <ul class="sidebar-module-list" itemprop="keywords"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Airbnb/" rel="tag">Airbnb</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Ajax/" rel="tag">Ajax</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Amazon/" rel="tag">Amazon</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Android/" rel="tag">Android</a><span class="sidebar-module-list-count">17</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Bootstrap/" rel="tag">Bootstrap</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ELK/" rel="tag">ELK</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Flink/" rel="tag">Flink</a><span class="sidebar-module-list-count">12</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Git/" rel="tag">Git</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/HTML-CSS-JS/" rel="tag">HTML/CSS/JS</a><span class="sidebar-module-list-count">32</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Hadoop/" rel="tag">Hadoop</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Hbase/" rel="tag">Hbase</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Hive/" rel="tag">Hive</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/JDBC/" rel="tag">JDBC</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/JSON/" rel="tag">JSON</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/JVM/" rel="tag">JVM</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/JavaSE/" rel="tag">JavaSE</a><span class="sidebar-module-list-count">76</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/JavaWeb/" rel="tag">JavaWeb</a><span class="sidebar-module-list-count">38</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Java%E5%85%B3%E9%94%AE%E5%AD%97/" rel="tag">Java关键字</a><span class="sidebar-module-list-count">8</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Java%E7%95%8C%E9%9D%A2/" rel="tag">Java界面</a><span class="sidebar-module-list-count">16</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/LaTex/" rel="tag">LaTex</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Linkedin/" rel="tag">Linkedin</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="sidebar-module-list-count">57</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ML/" rel="tag">ML</a><span class="sidebar-module-list-count">28</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Maven/" rel="tag">Maven</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/MySQL/" rel="tag">MySQL</a><span class="sidebar-module-list-count">23</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Nexus/" rel="tag">Nexus</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/NoSQL/" rel="tag">NoSQL</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Paper/" rel="tag">Paper</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Python/" rel="tag">Python</a><span class="sidebar-module-list-count">20</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Reading/" rel="tag">Reading</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Scala/" rel="tag">Scala</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Solr/" rel="tag">Solr</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Spark/" rel="tag">Spark</a><span class="sidebar-module-list-count">21</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/SpringMVC/" rel="tag">SpringMVC</a><span class="sidebar-module-list-count">13</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/TCP-IP/" rel="tag">TCP/IP</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/Thrift/" rel="tag">Thrift</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/antlr/" rel="tag">antlr</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/cdh/" rel="tag">cdh</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/docker/" rel="tag">docker</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/filebeat/" rel="tag">filebeat</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/flume/" rel="tag">flume</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/go/" rel="tag">go</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/google/" rel="tag">google</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/jquery/" rel="tag">jquery</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/kafka/" rel="tag">kafka</a><span class="sidebar-module-list-count">8</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/kerberos/" rel="tag">kerberos</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/ldap/" rel="tag">ldap</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/mac/" rel="tag">mac</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/nginx/" rel="tag">nginx</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/nlp/" rel="tag">nlp</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/open-falcon/" rel="tag">open-falcon</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/redis/" rel="tag">redis</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/twitter/" rel="tag">twitter</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/yarn/" rel="tag">yarn</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/zookeeper/" rel="tag">zookeeper</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E5%88%B7%E9%A2%98/" rel="tag">刷题</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E5%9B%BE%E5%AD%98%E5%82%A8%E5%8F%8A%E8%AE%A1%E7%AE%97/" rel="tag">图存储及计算</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" rel="tag">开发工具</a><span class="sidebar-module-list-count">15</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a><span class="sidebar-module-list-count">22</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">正则表达式</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a><span class="sidebar-module-list-count">27</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a><span class="sidebar-module-list-count">7</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>标签云</h4>
    <p class="tagcloud">
      <a href="/tags/Airbnb/" style="font-size: 12.5px;">Airbnb</a> <a href="/tags/Ajax/" style="font-size: 10px;">Ajax</a> <a href="/tags/Amazon/" style="font-size: 10px;">Amazon</a> <a href="/tags/Android/" style="font-size: 15.83px;">Android</a> <a href="/tags/Bootstrap/" style="font-size: 10px;">Bootstrap</a> <a href="/tags/ELK/" style="font-size: 13.75px;">ELK</a> <a href="/tags/Flink/" style="font-size: 14.17px;">Flink</a> <a href="/tags/Git/" style="font-size: 10.83px;">Git</a> <a href="/tags/HTML-CSS-JS/" style="font-size: 18.75px;">HTML/CSS/JS</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/Hbase/" style="font-size: 11.67px;">Hbase</a> <a href="/tags/Hive/" style="font-size: 12.5px;">Hive</a> <a href="/tags/JDBC/" style="font-size: 13.33px;">JDBC</a> <a href="/tags/JSON/" style="font-size: 10px;">JSON</a> <a href="/tags/JVM/" style="font-size: 10.42px;">JVM</a> <a href="/tags/JavaSE/" style="font-size: 20px;">JavaSE</a> <a href="/tags/JavaWeb/" style="font-size: 19.17px;">JavaWeb</a> <a href="/tags/Java%E5%85%B3%E9%94%AE%E5%AD%97/" style="font-size: 12.92px;">Java关键字</a> <a href="/tags/Java%E7%95%8C%E9%9D%A2/" style="font-size: 15.42px;">Java界面</a> <a href="/tags/LaTex/" style="font-size: 10px;">LaTex</a> <a href="/tags/Linkedin/" style="font-size: 10px;">Linkedin</a> <a href="/tags/Linux/" style="font-size: 19.58px;">Linux</a> <a href="/tags/ML/" style="font-size: 18.33px;">ML</a> <a href="/tags/Maven/" style="font-size: 10.83px;">Maven</a> <a href="/tags/MySQL/" style="font-size: 17.5px;">MySQL</a> <a href="/tags/Nexus/" style="font-size: 11.25px;">Nexus</a> <a href="/tags/NoSQL/" style="font-size: 10px;">NoSQL</a> <a href="/tags/Paper/" style="font-size: 10px;">Paper</a> <a href="/tags/Python/" style="font-size: 16.25px;">Python</a> <a href="/tags/Reading/" style="font-size: 10.83px;">Reading</a> <a href="/tags/Scala/" style="font-size: 13.33px;">Scala</a> <a href="/tags/Solr/" style="font-size: 10.83px;">Solr</a> <a href="/tags/Spark/" style="font-size: 16.67px;">Spark</a> <a href="/tags/SpringBoot/" style="font-size: 10.42px;">SpringBoot</a> <a href="/tags/SpringMVC/" style="font-size: 14.58px;">SpringMVC</a> <a href="/tags/TCP-IP/" style="font-size: 10.83px;">TCP/IP</a> <a href="/tags/Thrift/" style="font-size: 10.83px;">Thrift</a> <a href="/tags/antlr/" style="font-size: 10.42px;">antlr</a> <a href="/tags/cdh/" style="font-size: 10.83px;">cdh</a> <a href="/tags/docker/" style="font-size: 10.42px;">docker</a> <a href="/tags/filebeat/" style="font-size: 10.83px;">filebeat</a> <a href="/tags/flume/" style="font-size: 10.42px;">flume</a> <a href="/tags/go/" style="font-size: 10px;">go</a> <a href="/tags/google/" style="font-size: 10.42px;">google</a> <a href="/tags/jquery/" style="font-size: 10px;">jquery</a> <a href="/tags/kafka/" style="font-size: 12.92px;">kafka</a> <a href="/tags/kerberos/" style="font-size: 10px;">kerberos</a> <a href="/tags/ldap/" style="font-size: 10px;">ldap</a> <a href="/tags/mac/" style="font-size: 10.83px;">mac</a> <a href="/tags/nginx/" style="font-size: 12.08px;">nginx</a> <a href="/tags/nlp/" style="font-size: 10.42px;">nlp</a> <a href="/tags/open-falcon/" style="font-size: 10.83px;">open-falcon</a> <a href="/tags/redis/" style="font-size: 10.83px;">redis</a> <a href="/tags/twitter/" style="font-size: 10.42px;">twitter</a> <a href="/tags/yarn/" style="font-size: 10.42px;">yarn</a> <a href="/tags/zookeeper/" style="font-size: 13.75px;">zookeeper</a> <a href="/tags/%E5%88%B7%E9%A2%98/" style="font-size: 10px;">刷题</a> <a href="/tags/%E5%9B%BE%E5%AD%98%E5%82%A8%E5%8F%8A%E8%AE%A1%E7%AE%97/" style="font-size: 10.42px;">图存储及计算</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 13.75px;">多线程</a> <a href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">开发工具</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 17.08px;">数据结构</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 12.08px;">杂谈</a> <a href="/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 10px;">正则表达式</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 17.92px;">算法</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 12.5px;">设计模式</a>
    </p>
  </div>



  
  <div class="sidebar-module">
    <h4>文章归档</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2021/01/">一月 2021</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/12/">十二月 2020</a><span class="sidebar-module-list-count">10</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/11/">十一月 2020</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/10/">十月 2020</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/09/">九月 2020</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/08/">八月 2020</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/07/">七月 2020</a><span class="sidebar-module-list-count">12</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/06/">六月 2020</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/05/">五月 2020</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/04/">四月 2020</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/03/">三月 2020</a><span class="sidebar-module-list-count">10</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/02/">二月 2020</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2020/01/">一月 2020</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/10/">十月 2019</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/09/">九月 2019</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/08/">八月 2019</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/07/">七月 2019</a><span class="sidebar-module-list-count">8</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/04/">四月 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/03/">三月 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/01/">一月 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/12/">十二月 2018</a><span class="sidebar-module-list-count">4</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/11/">十一月 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/09/">九月 2018</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/06/">六月 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/05/">五月 2018</a><span class="sidebar-module-list-count">10</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/04/">四月 2018</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/02/">二月 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/01/">一月 2018</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/11/">十一月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/09/">九月 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/07/">七月 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/06/">六月 2017</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/05/">五月 2017</a><span class="sidebar-module-list-count">13</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/04/">四月 2017</a><span class="sidebar-module-list-count">24</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/03/">三月 2017</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/01/">一月 2017</a><span class="sidebar-module-list-count">24</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/12/">十二月 2016</a><span class="sidebar-module-list-count">15</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/11/">十一月 2016</a><span class="sidebar-module-list-count">20</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/10/">十月 2016</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/09/">九月 2016</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/08/">八月 2016</a><span class="sidebar-module-list-count">11</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/07/">七月 2016</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/06/">六月 2016</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/05/">五月 2016</a><span class="sidebar-module-list-count">32</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/04/">四月 2016</a><span class="sidebar-module-list-count">27</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/03/">三月 2016</a><span class="sidebar-module-list-count">140</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2016/02/">二月 2016</a><span class="sidebar-module-list-count">22</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/09/">九月 2015</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/08/">八月 2015</a><span class="sidebar-module-list-count">13</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/07/">七月 2015</a><span class="sidebar-module-list-count">31</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/06/">六月 2015</a><span class="sidebar-module-list-count">25</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2015/04/">四月 2015</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2013/04/">四月 2013</a><span class="sidebar-module-list-count">1</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>最近文章</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2021/01/22/ElasticSearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/">ElasticSearch学习笔记——插件开发</a>
        </li>
      
        <li>
          <a href="/2021/01/21/Hbase%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94rowkey/">Hbase学习笔记——rowkey</a>
        </li>
      
        <li>
          <a href="/2021/01/20/Hive%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94fetch/">Hive学习笔记——fetch</a>
        </li>
      
        <li>
          <a href="/2021/01/11/kafka%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94%E9%85%8D%E7%BD%AE/">kafka学习笔记——配置</a>
        </li>
      
        <li>
          <a href="/2021/01/07/ElasticSearch%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E2%80%94%E2%80%94ik%E5%88%86%E8%AF%8D%E6%B7%BB%E5%8A%A0%E8%AF%8D%E5%BA%93/">ElasticSearch学习笔记——ik分词添加词库</a>
        </li>
      
    </ul>
  </div>




        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2021 tonglin0325<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

  

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>



  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>



<script src="/js/jquery.qrcode.min.js"></script>



<script src="/js/jquery-1.6.2.min.js"></script>


</body>
</html>
